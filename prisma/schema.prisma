generator client {
  provider = "prisma-client"
  output   = "../prisma/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  password               String
  name                   String
  role                   UserRole  @default(USER)
  phone                  String?
  image_url              String?
  is_active              Boolean   @default(true)
  is_deleted             Boolean   @default(false)
  refresh_token          String?
  password_reset_token   String?
  password_reset_expires DateTime?
  password_reset_at      DateTime?
  credit_balance         Int       @default(100)
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt

  // Relations
  payments   Payment[]
  resumes    Resume[]
  proposals  Proposal[]
  creditLogs CreditLog[]

  @@index([email])
  @@map("users")
}

model Resume {
  id          String      @id @default(cuid())
  title       String // e.g., "Senior React Developer Resume"
  niche       ResumeNiche
  resume_url  String? // PDF Link
  resume_text String?     @db.Text // Extracted text for the AI to read
  is_default  Boolean     @default(false) // Helps auto-select for the user

  user_id   String
  user      User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  proposals Proposal[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([user_id])
  @@map("resumes")
}

model Proposal {
  id   String       @id @default(cuid())
  type ProposalType

  // Input Data
  job_url     String?
  job_title   String? // Added to make the history list look better
  job_details String  @db.Text

  // Output Data
  subject           String? // Important for "Job Application Email" type
  generated_content String  @db.Text

  // Settings used for generation
  tone     ProposalTone @default(PROFESSIONAL)
  language String       @default("English") // Future-proofing for multi-lang
  ai_model String? // e.g., "gpt-4o", "claude-3.5-sonnet"

  is_favorite Boolean @default(false)
  user_id     String
  resume_id   String?

  user      User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  resume    Resume?    @relation(fields: [resume_id], references: [id], onDelete: SetNull)
  creditLog CreditLog?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([user_id])
  @@map("proposals")
}

// --- BILLING & LOGGING MODELS ---

model CreditPackage {
  id             String           @id @default(cuid())
  name           String
  description    String?
  credits        Int
  price          Float
  is_active      Boolean          @default(true)
  is_recommended Boolean          @default(false)
  benefits       PackageBenefit[]
  payments       Payment[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("credit_packages")
}

model PackageBenefit {
  id                String        @id @default(cuid())
  benefit           String
  credit_package_id String
  creditPackage     CreditPackage @relation(fields: [credit_package_id], references: [id], onDelete: Cascade)

  @@map("package_benefits")
}

model Payment {
  id                 String        @id @default(cuid())
  user_id            String
  package_id         String?
  amount             Float
  currency           String        @default("USD") // Changed default to USD for international
  gateway_payment_id String?       @unique // Generic name instead of bkash
  gateway_trx_id     String?       @unique
  status             PaymentStatus @default(PENDING)
  credits_purchased  Int

  user      User           @relation(fields: [user_id], references: [id], onDelete: Restrict)
  package   CreditPackage? @relation(fields: [package_id], references: [id], onDelete: SetNull)
  creditLog CreditLog?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([user_id])
  @@map("payments")
}

model CreditLog {
  id          String     @id @default(cuid())
  amount      Int
  type        CreditType
  description String?    @db.Text

  user_id     String
  proposal_id String? @unique
  payment_id  String? @unique

  user     User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  proposal Proposal? @relation(fields: [proposal_id], references: [id], onDelete: SetNull)
  payment  Payment?  @relation(fields: [payment_id], references: [id], onDelete: SetNull)

  created_at DateTime @default(now())

  @@map("credit_logs")
}

// --- ENUMS ---

enum ResumeNiche {
  FRONTEND
  BACKEND
  FULL_STACK
  MOBILE
  UI_UX
  DEVOPS
  DATA_SCIENCE
  OTHER
}

enum ProposalType {
  UPWORK_COVER_LETTER
  JOB_APPLICATION_EMAIL
  LINKEDIN_MESSAGE
  COLD_EMAIL
}

enum ProposalTone {
  PROFESSIONAL
  FRIENDLY
  CONFIDENT
  CASUAL
  SHORT_CONCISE
}

enum UserRole {
  USER
  ADMIN
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum CreditType {
  PURCHASE
  USAGE
  BONUS
  REFUND
}
